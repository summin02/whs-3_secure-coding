<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ… - {{ user.nickname }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<div class="container mt-5" style="max-width: 600px;">
    <h4 class="mb-4">
        ğŸ’¬ {{ user.nickname }}ë‹˜ê³¼ì˜ ëŒ€í™”
        {% if user.is_blocked %}
            <span class="badge bg-danger ms-2">â›” ì°¨ë‹¨ëœ ì‚¬ìš©ì</span>
        {% endif %}
    </h4>

    {% if item %}
    <div class="alert alert-info mb-4 d-flex justify-content-between align-items-center">
        <div>
            ğŸ›’ ì´ ëŒ€í™”ëŠ” ìƒí’ˆ "<strong>{{ item.title }}</strong>" ì—ì„œ ì‹œì‘ë¨
        </div>
        <a href="/items/{{ item.id }}" class="btn btn-sm btn-outline-primary">ğŸ”— ìƒì„¸ë³´ê¸°</a>
    </div>
    {% endif %}

    <!-- âœ… ëŒ€í™”ë°© ì‚­ì œ ë²„íŠ¼ -->
    <form method="POST" action="/chat/delete/{{ receiver_id }}?item_id={{ item_id }}" 
          onsubmit="return confirm('ì´ ëŒ€í™”ë°©ì„ ì‚­ì œí• ê¹Œìš”?')">
        <button class="btn btn-sm btn-outline-danger mb-3">ğŸ—‘ ëŒ€í™”ë°© ì‚­ì œ</button>
    </form>

    <!-- âœ… ì‹¤ì‹œê°„ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
    <div class="chat-box border p-3 mb-4 bg-white" style="height: 400px; overflow-y: auto;">
        {% for msg in messages %}
            <div class="{% if msg.sender_id == session.user_id %}text-end{% else %}text-start{% endif %}">
                <p class="mb-1">
                    <strong>{{ msg.sender_name }}</strong>
                    {% if msg.sender_id == session.user_id %}
                        <button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="deleteMessage({{ msg.id }})">ğŸ–‘</button>
                    {% endif %}
                </p>
                <div class="d-inline-block px-3 py-2 rounded mb-3 {% if msg.sender_id == session.user_id %}bg-primary text-white{% else %}bg-light{% endif %}" id="msg-{{ msg.id }}">
                    {{ msg.content }}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- âœ… ë©”ì‹œì§€ ì „ì†¡ í¼ -->
    <form id="chat-form" method="POST">
        <div class="input-group">
            <input name="content" class="form-control" placeholder="ë©”ì‹œì§€ ì…ë ¥..." required>
            <button class="btn btn-primary" type="submit">ë³´ë‚´ê¸°</button>
        </div>
    </form>

    <div class="mt-3 d-flex justify-content-between">
        <a href="/" class="btn btn-outline-secondary btn-sm">â† ëŒì•„ê°€ê¸°</a>
        <!-- ìƒí’ˆ êµ¬ë§¤ ë²„íŠ¼ì„ "ëŒì•„ê°€ê¸°" ì˜¤ë¥¸ìª½ì— ë°°ì¹˜ -->
        {% if item and session.user_id == item.owner_id %}
            <button id="send-purchase-button" class="btn btn-success">ìƒí’ˆ êµ¬ë§¤ ë²„íŠ¼ ë³´ë‚´ê¸°</button>
        {% endif %}
    </div>
</div>

<!-- âœ… Socket.IO ì‹¤ì‹œê°„ ì²˜ë¦¬ -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
    const socket = io();
    socket.emit('join', { user_id: {{ session.user_id }} });

    const form = document.querySelector("#chat-form");
    const input = document.querySelector("input[name='content']");
    const chatBox = document.querySelector(".chat-box");

    socket.on('connect', function() {
        socket.emit('join', { user_id: {{ session.user_id }} });
        console.log("ğŸŸ¢ join ìš”ì²­ ì™„ë£Œ");
    });

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        const msg = input.value;
        if (msg.trim()) {
            console.log("ë³´ëƒ„:", msg);
            socket.emit("send_message", {
                sender_id: {{ session.user_id }},
                receiver_id: {{ receiver_id }},
                item_id: {{ item_id }},
                content: msg
            });
            input.value = '';
        }
    });

    // ì„œë²„ë¡œë¶€í„° ìƒí’ˆ êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ì„ ë°›ìœ¼ë©´ ì²˜ë¦¬
    socket.on('purchase_button', function(data) {
        console.log("ğŸ”” êµ¬ë§¤ ë²„íŠ¼ ìˆ˜ì‹ ë¨:", data); // â† ìš”ê²Œ ì•ˆ ì°íˆë©´ join ì•ˆ ëœ ìƒíƒœì„
        const itemId = data.item_id;
        const buttonHTML = `
            <div class="text-start">
                <p class="mb-1"><strong>íŒë§¤ì</strong></p>
                <div class="d-inline-block px-3 py-2 rounded mb-3 bg-light">
                    <a class="btn btn-sm btn-outline-primary" href="/buy/${itemId}">ìƒí’ˆ êµ¬ë§¤í•˜ê¸°</a>
                </div>
            </div>
        `;
        const chatBox = document.querySelector(".chat-box");
        chatBox.innerHTML += buttonHTML;
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on("receive_message", function(data) {
        console.log("ìˆ˜ì‹ :", data);
        const currentReceiver = {{ receiver_id }};
        const currentItem = {{ item_id }};
        const myId = {{ session.user_id }};

        if (
            data.item_id === currentItem &&
            ((data.sender_id === currentReceiver && data.receiver_id === myId) ||
             (data.sender_id === myId && data.receiver_id === currentReceiver))
        ) {
            const div = document.createElement("div");
            div.className = (data.sender_id === myId) ? "text-end" : "text-start";
            div.innerHTML = `
                <p class="mb-1"><strong>${data.sender_name}</strong></p>
                <div class="d-inline-block px-3 py-2 rounded mb-3 ${data.sender_id === myId ? 'bg-primary text-white' : 'bg-light'}" id="msg-${data.id}">
                    ${data.content}
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    });

    function deleteMessage(msgId) {
        if (confirm("ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
            socket.emit('delete_message', { id: msgId });
        }
    }

    socket.on("message_deleted", function(data) {
        const target = document.getElementById("msg-" + data.id);
        if (target) {
            target.innerHTML = "<em class='text-muted'>ì‚­ì œëœ ë©”ì‹œì§€</em>";
        }
    });

    // íŒë§¤ìê°€ ìƒí’ˆ êµ¬ë§¤ ë²„íŠ¼ì„ ë³´ë‚¼ ë•Œ
    document.getElementById('send-purchase-button').onclick = function() {
        const itemId = {{ item.id }};  // í˜„ì¬ ìƒí’ˆ ID ì‚¬ìš©
        console.log("ìƒí’ˆ êµ¬ë§¤ ë²„íŠ¼ ì „ì†¡:", itemId);

        // íŒë§¤ìê°€ ë²„íŠ¼ì„ ë³´ë‚´ë©´, ì„œë²„ë¡œ ì´ë²¤íŠ¸ ì „ì†¡
        socket.emit('send_purchase_button', {
            sender_id: {{ session.user_id }},
            receiver_id: {{ receiver_id }},
            item_id: itemId
        });

        // ë²„íŠ¼ì„ í´ë¦­í•œ í›„ ìˆ¨ê¸°ê¸°
        this.style.display = 'none'; 
    };

</script>
</body>
</html>